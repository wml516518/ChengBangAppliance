@model List<ManualOrder>
@{
    ViewData["Title"] = "自建工单";
    int? currentStatus = ViewBag.CurrentStatus as int?;
    var typeDict = ViewBag.TypeDict as Dictionary<int, string> ?? new Dictionary<int, string>();
    var itemDict = ViewBag.ItemDict as Dictionary<int, string> ?? new Dictionary<int, string>();
    var workerDict = ViewBag.WorkerDict as Dictionary<int, string> ?? new Dictionary<int, string>();

    string StatusText(int s) => s switch { 0 => "待指派", 1 => "已指派", 2 => "进行中", 3 => "已完成", 4 => "已取消", _ => "未知" };
    string StatusBadge(int s) => s switch { 0 => "badge-warning", 1 => "badge-info", 2 => "badge-primary", 3 => "badge-success", 4 => "badge-secondary", _ => "" };
}
<style>
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-primary { background: #2563eb; color: #fff; }
    .status-filter { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
</style>
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
        <h2 style="margin:0;">自建工单管理</h2>
        <a href="/ManualOrders/Create" class="btn btn-primary">创建工单</a>
    </div>
    <div class="status-filter" style="margin-top:12px;">
        <a href="/ManualOrders" class="btn @(currentStatus == null ? "btn-primary" : "btn-secondary") btn-sm">全部</a>
        <a href="/ManualOrders?status=0" class="btn @(currentStatus == 0 ? "btn-primary" : "btn-secondary") btn-sm">待指派</a>
        <a href="/ManualOrders?status=1" class="btn @(currentStatus == 1 ? "btn-primary" : "btn-secondary") btn-sm">已指派</a>
        <a href="/ManualOrders?status=2" class="btn @(currentStatus == 2 ? "btn-primary" : "btn-secondary") btn-sm">进行中</a>
        <a href="/ManualOrders?status=3" class="btn @(currentStatus == 3 ? "btn-primary" : "btn-secondary") btn-sm">已完成</a>
        <a href="/ManualOrders?status=4" class="btn @(currentStatus == 4 ? "btn-primary" : "btn-secondary") btn-sm">已取消</a>
    </div>
    @if (Model.Count == 0)
    {
        <p>暂无工单记录。</p>
    }
    else
    {
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>工单号</th>
                        <th>订单类型</th>
                        <th>服务项目</th>
                        <th>保修</th>
                        <th>金额</th>
                        <th>预约时间</th>
                        <th>联系人</th>
                        <th>联系电话</th>
                        <th>状态</th>
                        <th>指派师傅</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var o in Model)
                    {
                        <tr>
                            <td style="font-family:monospace; font-size:13px;">@o.OrderNo</td>
                            <td>@(typeDict.ContainsKey(o.ServiceTypeId) ? typeDict[o.ServiceTypeId] : "-")</td>
                            <td>@(itemDict.ContainsKey(o.ServiceItemId) ? itemDict[o.ServiceItemId] : "-")</td>
                            <td>
                                @if (o.WarrantyType == 1)
                                { <span class="badge" style="background:#fef2f2;color:#dc2626;">保外</span> }
                                else
                                { <span class="badge" style="background:#dcfce7;color:#166534;">包内</span> }
                            </td>
                            <td style="color:#dc2626; font-weight:500;">¥@o.Amount.ToString("F2")</td>
                            <td style="font-size:13px; white-space:nowrap;">
                                @if (o.AppointmentStart.HasValue && o.AppointmentEnd.HasValue)
                                {
                                    @o.AppointmentStart.Value.ToString("MM-dd HH:mm")
                                    <span style="color:#9ca3af;">~</span>
                                    @o.AppointmentEnd.Value.ToString("MM-dd HH:mm")
                                }
                                else if (o.AppointmentStart.HasValue)
                                {
                                    @o.AppointmentStart.Value.ToString("MM-dd HH:mm")
                                    <span style="color:#9ca3af;">起</span>
                                }
                                else
                                {
                                    <span>—</span>
                                }
                            </td>
                            <td>@o.ContactName</td>
                            <td>@o.ContactPhone</td>
                            <td><span class="badge @StatusBadge(o.Status)">@StatusText(o.Status)</span></td>
                            <td>@(o.AssignedUserId.HasValue && workerDict.ContainsKey(o.AssignedUserId.Value) ? workerDict[o.AssignedUserId.Value] : "—")</td>
                            <td style="font-size:13px;">@o.CreateTime.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <a href="/ManualOrders/Detail/@o.Id" class="btn btn-primary btn-sm">详情</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
